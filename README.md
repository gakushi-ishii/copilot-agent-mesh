# Copilot Agent Teams

複数の GitHub Copilot セッションを協調させ、エージェント同士が双方向にメッセージをやり取りしながらタスクを遂行する、マルチエージェントオーケストレーションの PoC（概念実証）です。

[`@github/copilot-sdk`](https://www.npmjs.com/package/@github/copilot-sdk) の複数セッション管理機能を活用し、インメモリのメッセージバスとカスタムツール注入によって、Claude Code の Agent Teams に類似した Lead + Teammates パターンを実現します。単方向のサブエージェントとは異なり、チームメイト同士がメールボックスを通じて直接対話できる点が特徴です。

## 目次

- [前提条件](#前提条件)
- [インストール / セットアップ](#インストール--セットアップ)
- [使い方](#使い方)
- [機能一覧](#機能一覧)
- [アーキテクチャ](#アーキテクチャ)
- [コマンドリファレンス](#コマンドリファレンス)
- [設定 / カスタマイズ](#設定--カスタマイズ)
- [ライセンス](#ライセンス)

## 前提条件

| 項目 | バージョン |
|------|-----------|
| Node.js | 18 以上 |
| GitHub Copilot CLI | 最新版 |
| GitHub Copilot ライセンス | 有効なサブスクリプション |

> [!NOTE]
> `@github/copilot-sdk` は technical preview（v0.1.x）のため、破壊的変更が入る可能性があります。

## インストール / セットアップ

1. リポジトリをクローンします。

   ```bash
   git clone https://github.com/gakushi-ishii/copilot-agent-teams.git
   cd copilot-agent-teams
   ```

2. 依存パッケージをインストールします。

   ```bash
   npm install
   ```

3. GitHub Copilot CLI が PATH に通っていることを確認します。

   ```bash
   copilot --version
   ```

4. TypeScript をビルドします（任意。`tsx` で直接実行する場合は不要です）。

   ```bash
   npm run build
   ```

## 使い方

### 対話モード

ターミナルで対話しながらタスクをチームに指示できます。

```bash
npm start
```

起動後、プロンプトにタスクを入力すると Lead エージェントがチームを編成し、作業を開始します。

```text
🤖 Task> 3つの観点（セキュリティ・パフォーマンス・テストカバレッジ）でPRをレビューして
```

### ワンショットモード

タスクを引数で渡し、完了まで自動実行します。

```bash
npm start -- --task "認証モジュールのセキュリティレビューを実施して"
```

### セッション中のコマンド

対話モードでは以下のコマンドが利用できます。

| コマンド | 説明 |
|---------|------|
| `/status` | 全エージェントの一覧と状態を表示 |
| `/agents` | アクティブなエージェント一覧を表示 |
| `/tasks` | 共有タスクリストを表示 |
| `/msg <id> <text>` | 特定のエージェントに直接メッセージを送信 |
| `quit` | チームを停止して終了 |

## 機能一覧

- **双方向エージェント間通信** — メールボックス方式でエージェント同士がメッセージを送受信します
- **共有タスクリスト** — 依存関係つきのタスクを作成・割当・完了管理します
- **動的チーム編成** — Lead が `spawn_teammate` ツールでチームメイトを動的に生成します
- **ブロードキャスト** — 全チームメイトへの一斉通知が可能です
- **ストリーミング出力** — 各エージェントの応答をリアルタイムで表示します
- **カスタムツール注入** — `defineTool()` + Zod スキーマでエージェントにツールを配布します

## アーキテクチャ

```text
┌──────────────────────────────────────────────────┐
│               Orchestrator (Node.js)             │
│                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │  Lead    │  │Teammate A│  │Teammate B│ ...   │
│  │ Session  │  │ Session  │  │ Session  │       │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘       │
│       │              │              │             │
│  ┌────┴──────────────┴──────────────┴────┐       │
│  │        Message Bus (in-memory)        │       │
│  │   Mailbox + Task List + EventEmitter  │       │
│  └───────────────────────────────────────┘       │
│                                                  │
│  ┌───────────────────────────────────────┐       │
│  │     CopilotClient (1 instance)        │       │
│  │    ← JSON-RPC → Copilot CLI           │       │
│  └───────────────────────────────────────┘       │
└──────────────────────────────────────────────────┘
```

### 技術スタック

| 技術 | 用途 |
|------|------|
| TypeScript (ES2022) | 実装言語 |
| `@github/copilot-sdk` | Copilot CLI のプログラマティック制御 |
| `zod` | カスタムツールのスキーマ定義 |
| `tsx` | TypeScript の直接実行 |
| Node.js EventEmitter | メッセージバスのイベント通知 |

### ソースファイル構成

| ファイル | 役割 |
|---------|------|
| `src/message-bus.ts` | インメモリのメールボックスと共有タスクリスト |
| `src/agent-tools.ts` | `defineTool()` によるカスタムツール定義 |
| `src/agent-session.ts` | エージェント情報の型定義とシステムメッセージ生成 |
| `src/orchestrator.ts` | チーム管理・メッセージ配送ループの中核エンジン |
| `src/index.ts` | CLI エントリポイント（対話 / ワンショット両モード） |

### 双方向通信の仕組み

1. エージェントが `send_message` ツールを呼び出します
2. ツールハンドラが Message Bus のメールボックスに書き込みます
3. ポーリングループが受信側の未読メッセージを検出します
4. 未読メッセージをプロンプトとして受信側セッションに自動投入します
5. 受信側エージェントがメッセージを読んで応答・行動します

## コマンドリファレンス

| コマンド | 説明 |
|---------|------|
| `npm start` | 対話モードで起動 |
| `npm start -- --task "..."` | ワンショットモードで起動 |
| `npm run build` | TypeScript をコンパイル |
| `npm run dev` | ウォッチモードで起動 |
| `npm test` | MessageBus の単体テストを実行 |

## 設定 / カスタマイズ

環境変数で動作をカスタマイズできます。

| 環境変数 | デフォルト | 説明 |
|---------|-----------|------|
| `COPILOT_MODEL` | `gpt-5` | 使用するモデル（`claude-sonnet-4.5` 等） |
| `POLL_INTERVAL_MS` | `2000` | メッセージポーリング間隔（ミリ秒） |
| `LOG_LEVEL` | `info` | ログ出力レベル（`info` / `debug`） |

```bash
COPILOT_MODEL=claude-sonnet-4.5 LOG_LEVEL=debug npm start
```

## ライセンス

ISC
